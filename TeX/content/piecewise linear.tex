% !TEX root = ../main.tex

\section{Piecewise linear function}\label{sec:pwl}

We review in this section the basic mathmatical facts about piecewise linear
functions that are needed for this work. Normally such functions are defined on
the real numbers, but it is sufficient for our purposes to defined them on the natural
numbers.

\begin{definition}
  \label{def:PW}
  For any $U \in \mathbb{N}$, a function $f : U \rightarrow \mathbb{N}$ is said
  to be piecewise linear on $U$ if there exists a finite set $Q$ of pairs
  such that for each pair $(q,g)$, $q$ is an interval of $U$, $g$ is a linear
  function and $f$ is equal to $g$ on $q$. The intervals of $Q$ must be a
  partition of $U$. The set $Q$ is called the set of components.
\end{definition}
Note that from the definition, a set of components $Q$ of $f$ is not unique. Also, if
$Q$ is a set of components of $f$, we will when it makes sense abuse the
function notation and write $Q(x)$ for $f(x)$ since by definition there is a
single pair $(q, g)$ of $Q$ where $x \in q$ and we have $g = f$ on $q$. 

\begin{lemma}
  \label{thm:union_pwl}
  If $f_1 : U_1 \rightarrow \mathbb{N}$ and $f_2 : U_2 \rightarrow \mathbb{N}$
  are piecewise linear function such that $U_1 \cap U_2 = \emptyset$, then the
  function $f : U_1 \cup U_2 \rightarrow \mathbb{N}$ defined as
  \begin{equation}
    f(x) = \begin{cases}
      f_1(x) \quad \text{if $x \in U_1$} \\
      f_2(x) \quad \text{if $x \in U_2$} 
    \end{cases}
  \end{equation}
  is also a piewise linear function and $Q_1 \cup Q_2$ is a set of components of $f$.
\end{lemma}
\begin{proof}
  $Q_1 \cup Q_2$ meat all the requirements of defintion \ref{def:PW} to show
  that $f$ is a piecewise linear function.
\end{proof}

\subsection{Composition of piecewise linear functions}


\begin{lemma}
  The composition $f = f_2 \circ f_1 $ of two piecewise linear functions $f_1 :
  \mathbb{N} \rightarrow \mathbb{N}$ and $f_2 : \mathbb{N} \rightarrow
  \mathbb{N}$ is also a piecewise linear function. A set of components $Q$ can
  be obtained from the sets of components $Q_1$ and $Q_2$ of $f_1$ and $f_2$.
\end{lemma}
\begin{proof}
  We show how to build a set of components $Q$ for $f$. For each pair $(q, g)$
  in $Q_1$, we will build a piecewise linear function $h : q \rightarrow
  \mathbb{N}$ with a set of components $X$ such that $h(x) = f(x) = (f_2 \circ
  f_1)(x)$ if $x \in q$. It follows from lemma \ref{thm:union_pwl} that the
  union of all such set $X$ for all pair in $Q_1$ is a set of components of $f$.
  
  We now show how to build a set $X$ from an element $([x,y], g)$ of $Q_1$.
  The special case where $g$ is constant with value $a$ implies that $f(u) =
  f_2(a)$ if $u \in [x,y]$. Since $u$ belongs to an unique pair $(q_2, g_2)$ in
  $Q_2$, we define $X = \{[x,y], g_a\}$ where $g_a$ is the constant function
  $g_a(x) = g_2(a)$ and we have that for all $u \in [x,y]$, $X(u) = g_a(u) =
  g_2(a) = f_2(a) = f(u)$.

  If $g$ is not a constant, since $g$ is linear we have an image interval $[x',
  y']$ where $x' = \text{min}(g(x),g(y))$ and $y' = \text{max}(g(x),g(y))$. Let
  $\Gamma$ be the set of all components in $Q_2$ that overlaps with the interval
  $[x',y']$ restricted to that overlap.
  \begin{equation*}
    \Gamma = \{(q \cap [x',y'], h) \ | \ (q, h) \in Q_2 \land q \cap [x',y'] \neq \emptyset \}
  \end{equation*}
  It is clear that $\Gamma$ is a partition of $[x',y']$ and a set of components
  for the function $f_2$ restricted on $[x',y']$. Again, since $g$ is linear and
  not a constant we can inverse the intervals in $\Gamma$ to expressed them as a
  partition of $[x,y]$. We therefore define the set $X$ like this:
  \begin{equation*}
    X = \{([a^{-1}, b^{-1}], h \circ g) \ | \ 
    ([a,b], h) \in \Gamma, 
    a^{-1} = \text{min}(g^{-1}(a), g^{-1}(b)), 
    b^{-1} = \text{max}(g^{-1}(a), g^{-1}(b)) \}
  \end{equation*}
  As mentionned above, the intervals of $X$ are a partition of $[x,y]$. For any
  pair $(p, j \circ g)$ of $X$, we have that $g = f_1$ on $p$ since
  $p \in q$ and we have that $j = f_2$ on the image interval of $p$ by
  $g$ by construction of $X$. So for all pairs $X(x) = (f_2 \circ f_1)(x)$ and
  thus $X$ is a set of components of $f$ restricted on $[x,y]$.

\end{proof}

% The backbone of a substitution is a piecewise linear function with all slopes
% equal to one. We use the abbreviation $\text{pwl}$ to denote such functions.
% Such a piecewise linear function can be characterized by its points of
% discontinuity, where they are and the offset relative to the next segment. As
% such, this kind of piecewise linear function can be represented by a list of
% tuples $[(i_1,k_1),(i_2,k_2)\ldots(i_n,k_n)]$. The meaning of the tuple $(i, k)$
% is that the "jump" by $k$ occurs \emph{at} the value $i$. When the context is
% clear, we simple write $i_n$ and $k_n$ the first and second parameters of the
% ith tuple in the list.

% We call such a list of tuples the support of the function. To make the
% representation unique, we ask that the list is well-formed with ordered tuples
% and with all non zero offset.  Note that, We can always take an arbitrary list
% of tuples and compute an well-formed one equivalent. Also, the identity function
% is encoded as the well-formed support $[]$.

% \begin{equation*}
%   \text{pwl} \equiv [(i_1,k_1),(i_2,k_2)\ldots(i_n,k_n)]
% \end{equation*}
% \begin{equation*}
%   \text{wf} \ [(i_1,k_1),(i_2,k_2)\ldots(i_n,k_n)] \leftrightarrow 
%     (\forall n \, m, n < m \rightarrow i_n < i_m)  \land \forall n, k_n \neq 0 
% \end{equation*}

% From its reprensentation, we can easily compute the value of any piecewise linear function $f$.
% \begin{gather*}
%   \text{f} \ x = \text{lookup} \ x \ [(i_1,k_1),(i_2,k_2)\ldots(i_n,k_n)] \\
%   \text{lookup} \ x \ [] = x \\
%   \text{lookup} \ x \ [(i_1,k_1),(i_2,k_2)\ldots(i_n,k_n)] = 
%   \begin{cases}
%     x \quad \text{if $x < i_1$} \\
%     k_1 + \text{lookup} \ x \ [(i_2,k_2)\ldots(i_n,k_n)] \quad \text{otherwise} 
%   \end{cases}
% \end{gather*}

% Two piecewise linear functions are equal if their well-formed support are equal.
% This is an important property of well-formed supports, because it means we can
% compute the extensional equality of function by computing the intensional
% equality of their supports.

% \subsection{composition}\label{sec:pwl_composition}
% \begin{align*}
%   \text{compose}& \ [] \ f_2  ={} f_2 \\
%   \text{compose}& \ f_1 \  [] ={} f_1 \\
%   \text{compose}& \ ((i_1,k_1) :: x_1) \ ((i_2,k_2) :: x_2) ={} \\ 
%     &\begin{cases}
%        \quad \text{if $i_1 < i_2$} \\
%       \quad \text{if $i_1 = i_2$} \\
%       (i_2, k_2) :: \text{compose} \ ((i_1,k_1) :: x_1) \ x_2 \quad \text{if $i_1 > i_2$} \\
%     \end{cases}
% \end{align*}